#!/bin/bash
# This script check the compatibility between file_def_xxx.xml files and
# field_def_xxx.xml. It just check that field_ref asked in file_def are
# well defined in field_def file. 
# So far check is done for oce and ice

usage() {
   echo
   echo "USAGE : $(basename $0) [-h] "
   echo
   echo "  PURPOSE: "
   echo "     Check that file_def_xxx.xml files are coherent with field_def_xxx.xml files"
   echo
   echo "  ARGUMENTS:"
   echo "     none "
   echo
   echo "  OPTIONS:"
   echo "    -h : print this help message and exit."
   echo
   exit 0
        }

# function for text color
set_color() {
r="\033[31m"  # red
g="\033[32m"  # green
b="\033[34m"  # blue
m="\033[35m"  # magenta
k="\033[0m"   # black/reset
#
# more font effect
bld="\033[1m"
ita="\033[3m"
und="\033[4m"
str="\033[9m"
            }

# command parser
while getopts :h opt ; do
   case $opt in
     (h) usage ;;
     (*) usage ;;
    esac
done

set_color

for typ in oce ice ; do
  rm -f .field_lst.txt .fieldid_lst.txt
  # set the list of existing fields
  grep field\ id field_def_nemo-$typ.xml | awk -F= '{print $2}' |awk -F\" '{print $2}' | sort -u > .fieldid_lst.txt
  # scan all filedef for this type
  for filexml in file_def*nemo-$typ.xml ; do
    # set the list of field_ref in filexml
    grep field_ref $filexml | awk -F= '{print $2}' |awk -F\" '{print $2}' | sort -u > .field_lst.txt
    for fr in $(cat .field_lst.txt) ; do
       grep -q -w $fr .fieldid_lst.txt
       if [ $? != 0 ] ; then
        printf " $bld${r}ERROR${k} : ${bld}$fr${k} (${filexml}) is not defined in field_def_nemo-$typ.xml \n"
        grep --color -Hn -C 3 $fr ${filexml} 
       fi
    done
  done
done

